name: Continuous Integration

on:
  push:
    branches:
      - main
      - master

jobs:
  testing:
    name: testing
    uses: yankeeinlondon/gha/.github/workflows/test.yml@main

  publish:
    name: npm
    if: ( contains(github.event.head_commit.message, 'release v') )
    needs:
      - testing
    uses: yankeeinlondon/gha/.github/workflows/npm.yml@main
    with:
      nodeVersion: 22
    secrets:
      npm_token: ${{secrets.NPM_TOKEN}}

  publish_jsr:
    name: jsr
    if: ( contains(github.event.head_commit.message, 'release v') )
    needs:
      - testing
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: pnpm/action-setup@v2
        with:
          version: latest
      - run: pnpm install --frozen-lockfile
      - name: Publish to JSR
        run: npx jsr publish

  # publish_github:
  #   name: github packages
  #   if: ( contains(github.event.head_commit.message, 'release v') )
  #   needs:
  #     - testing
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     packages: write
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: 22
  #     - uses: pnpm/action-setup@v2
  #       with:
  #         version: latest
  #     - run: pnpm install --frozen-lockfile
  #     - run: pnpm build
  #     - name: Setup GitHub Packages registry
  #       run: |
  #         cp .npmrc.github .npmrc
  #     - name: Publish to GitHub Packages
  #       run: npm publish
  #       env:
  #         GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

  do_not_publish:
    name: npm / no publication
    if: ( !contains(github.event.head_commit.message, 'release v') )
    runs-on: ubuntu-latest
    needs:
      - testing
    steps:
      - name: Done
        run: |
          echo "::notice ::No need to publish to NPM"
